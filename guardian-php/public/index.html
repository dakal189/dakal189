<!doctype html>
<html lang="fa">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Dakal Guardian • Admin</title>
	<style>
		:root{
			--bg:#0f172a; /* slate-900 */
			--panel:#111827cc; /* gray-900/80 */
			--card:#0b1222cc; /* custom */
			--text:#e5e7eb; /* gray-200 */
			--muted:#9ca3af; /* gray-400 */
			--brand:#6366f1; /* indigo-500 */
			--brand2:#06b6d4; /* cyan-500 */
			--success:#22c55e; /* green-500 */
			--danger:#ef4444; /* red-500 */
		}
		html,body{height:100%}
		body{font-family:IRANSans,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;background:
			radial-gradient(1200px 800px at 100% -10%, #1e293b 0%, #0f172a 70%),
			linear-gradient(160deg, rgba(99,102,241,.15), rgba(6,182,212,.08));
			min-height:100%;margin:0;color:var(--text)}
		.container{max-width:1100px;margin:0 auto;padding:32px}
		.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
		.brand{display:flex;align-items:center;gap:12px}
		.logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,var(--brand),var(--brand2));box-shadow:0 10px 30px rgba(99,102,241,.35)}
		.title{font-weight:800;letter-spacing:.3px}
		.subtitle{color:var(--muted);font-size:.95rem;margin-top:4px}
		.panel{border:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg, rgba(17,24,39,.8), rgba(11,18,34,.7));border-radius:18px;padding:18px}
		.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:14px}
		.card{border:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg, rgba(11,18,34,.7), rgba(9,14,28,.65));border-radius:16px;padding:16px}
		.card h3{margin:0 0 10px 0;font-size:1.05rem}
		label{display:flex;justify-content:space-between;align-items:center;border:1px solid rgba(255,255,255,.06);padding:10px;border-radius:12px;background:rgba(255,255,255,.02)}
		input,textarea,select{background:rgba(255,255,255,.06);color:var(--text);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px;width:100%}
		.small{color:var(--muted)}
		button{background:linear-gradient(135deg,var(--brand),var(--brand2));color:white;border:none;border-radius:12px;padding:10px 14px;cursor:pointer;box-shadow:0 10px 25px rgba(99,102,241,.35)}
		button.secondary{background:transparent;border:1px solid rgba(255,255,255,.12)}
		.toggle{width:48px;height:26px;border-radius:999px;background:rgba(255,255,255,.15);position:relative;cursor:pointer;border:1px solid rgba(255,255,255,.2)}
		.toggle.on{background:linear-gradient(135deg,var(--success),#16a34a)}
		.toggle>span{position:absolute;top:2px;right:2px;width:22px;height:22px;border-radius:999px;background:#fff;transition:all .2s}
		.toggle.on>span{right:24px}
		table{width:100%;border-collapse:collapse}
		th,td{border-bottom:1px solid rgba(255,255,255,.08);padding:10px;text-align:right}
		hr{border:none;border-top:1px solid rgba(255,255,255,.08);margin:10px 0}
	</style>
</head>
<body dir="rtl">
	<div class="container">
		<div class="header">
			<div class="brand">
				<div class="logo"></div>
				<div>
					<div class="title">Dakal • Guardian</div>
					<div class="subtitle">مدیریت حرفه‌ای گروه و کانال با امنیت هوشمند</div>
				</div>
			</div>
			<div class="small">مینی‌اپ مدیریت</div>
		</div>

		<div class="panel" style="margin-bottom:14px">
			<div class="grid">
				<div class="card">
					<h3>احراز هویت</h3>
					<div class="grid">
						<input id="chatId" placeholder="Chat ID"/>
						<input id="userId" placeholder="User ID"/>
						<input id="timestamp" placeholder="Timestamp"/>
						<input id="hash" placeholder="Hash"/>
					</div>
					<div style="margin-top:10px;display:flex;gap:10px"><button id="auth">اتصال</button><button class="secondary" id="fill">پر کردن خودکار URL</button></div>
					<div class="small" style="margin-top:6px">پارامترهای بالا با لینک /settings تامین می‌شود.</div>
				</div>
				<div class="card">
					<h3>وضعیت</h3>
					<div class="small">پس از اتصال، تنظیمات گروه، ادمین‌ها و لاگ‌ها قابل مشاهده و ویرایش است.</div>
					<hr/>
					<div class="small">برند: Dakal • Guardian</div>
				</div>
			</div>
		</div>

		<div id="settings" class="panel" style="display:none">
			<h3 style="margin:0 0 12px 0">تنظیمات گروه</h3>
			<div class="grid">
				<label>ضد لینک <div class="toggle" data-key="anti_link"><span></span></div></label>
				<label>ضد فوروارد <div class="toggle" data-key="anti_forward"><span></span></div></label>
				<label>فیلتر کلمات بد <div class="toggle" data-key="anti_badwords"><span></span></div></label>
				<label>کپچا هنگام ورود <div class="toggle" data-key="captcha_required"><span></span></div></label>
				<label>حداکثر اخطار <input id="max_warns" type="number" min="1" max="10"/></label>
				<label>بنر خوش‌آمد (URL) <input id="welcome_banner_url" placeholder="https://..."/></label>
				<label style="grid-column:1/-1">متن خوش‌آمد <textarea id="welcome_text" rows="3" placeholder="خوش آمدید به جامعه Dakal!"></textarea></label>
				<label>لاکدان گروه <div class="toggle" data-key="lockdown"><span></span></div></label>

				<label>قفل هشتگ <div class="toggle" data-key="lock_hashtag"><span></span></div></label>
				<label>قفل یوزرنیم <div class="toggle" data-key="lock_username"><span></span></div></label>
				<label>قفل لینک <div class="toggle" data-key="lock_link"><span></span></div></label>
				<label>قفل متن <div class="toggle" data-key="lock_text"><span></span></div></label>
				<label>قفل فارسی <div class="toggle" data-key="lock_persian"><span></span></div></label>
				<label>قفل انگلیسی <div class="toggle" data-key="lock_english"><span></span></div></label>
				<label>قفل بازی <div class="toggle" data-key="lock_games"><span></span></div></label>
				<label>قفل فحش <div class="toggle" data-key="lock_profanity"><span></span></div></label>
				<label>قفل سرویس تلگرام <div class="toggle" data-key="lock_service"><span></span></div></label>
				<label>قفل دکمه شیشه‌ای <div class="toggle" data-key="lock_inline_button"><span></span></div></label>
				<label>قفل ربات‌ها <div class="toggle" data-key="lock_bots"><span></span></div></label>
				<label>قفل ویرایش <div class="toggle" data-key="lock_edit"><span></span></div></label>
				<label>قفل ایموجی <div class="toggle" data-key="lock_emoji"><span></span></div></label>
				<label>قفل فوروارد <div class="toggle" data-key="lock_forward"><span></span></div></label>
				<label>قفل گیف <div class="toggle" data-key="lock_gif"><span></span></div></label>
				<label>قفل استیکر <div class="toggle" data-key="lock_sticker"><span></span></div></label>
				<label>قفل عکس <div class="toggle" data-key="lock_photo"><span></span></div></label>
				<label>قفل فایل <div class="toggle" data-key="lock_file"><span></span></div></label>
				<label>قفل مخاطب <div class="toggle" data-key="lock_contact"><span></span></div></label>
				<label>قفل مکان <div class="toggle" data-key="lock_location"><span></span></div></label>
				<label>قفل اسپویلر <div class="toggle" data-key="lock_spoiler"><span></span></div></label>
				<label>قفل کامند <div class="toggle" data-key="lock_command"><span></span></div></label>
				<label>قفل سنجاق <div class="toggle" data-key="lock_pin"><span></span></div></label>
				<label>قفل فیلم <div class="toggle" data-key="lock_video"><span></span></div></label>
				<label>قفل فیلم سلفی <div class="toggle" data-key="lock_video_note"><span></span></div></label>
				<label>قفل صدا <div class="toggle" data-key="lock_audio"><span></span></div></label>
				<label>قفل ویس <div class="toggle" data-key="lock_voice"><span></span></div></label>
			</div>
			<div style="margin-top:12px"><button id="save">ذخیره تنظیمات</button></div>
		</div>

		<div id="admins" class="panel" style="display:none;margin-top:14px">
			<h3 style="margin:0 0 12px 0">ادمین‌ها و دسترسی‌ها</h3>
			<div class="card" style="overflow:auto">
				<table>
					<thead><tr><th>کاربر</th><th>حذف</th><th>محدودسازی</th><th>پین</th><th>مدیریت</th><th>اعمال</th></tr></thead>
					<tbody></tbody>
				</table>
			</div>
		</div>

		<div id="owner" class="panel" style="display:none;margin-top:14px">
			<h3 style="margin:0 0 12px 0">کنترل مالک Dakal</h3>
			<div class="grid">
				<label>وضعیت ربات
					<select id="botDisabled">
						<option value="0">روشن</option>
						<option value="1">خاموش</option>
					</select>
				</label>
				<label>Force Join Channel ID <input id="forceChannelId" placeholder="@channel یا -100..."/></label>
			</div>
			<div style="margin-top:8px;display:flex;gap:8px"><button id="saveOwner">ذخیره مالک</button></div>
			<div style="margin-top:16px" class="card">
				<h3 style="margin:0 0 10px 0">ارسال تبلیغات</h3>
				<div style="display:flex;gap:8px"><input id="broadcastText" placeholder="متن تبلیغ"/><button id="sendBroadcast">ارسال</button></div>
			</div>
		</div>

		<div id="sanctions" class="panel" style="display:none;margin-top:14px">
			<h3 style="margin:0 0 12px 0">لاگ اقدامات</h3>
			<div class="card" style="overflow:auto">
				<table>
					<thead><tr><th>کاربر</th><th>اقدام</th><th>دلیل</th><th>تاریخ</th></tr></thead>
					<tbody></tbody>
				</table>
			</div>
		</div>
		<div class="panel" id="myChats" style="display:none;margin-bottom:14px">
			<h3 style="margin:0 0 12px 0">گروه‌ها و کانال‌های من</h3>
			<div class="card" style="overflow:auto">
				<table>
					<thead><tr><th>چت</th><th>شناسه</th><th>نوع</th><th>اقدام</th></tr></thead>
					<tbody></tbody>
				</table>
			</div>
		</div>
	</div>

	<script>
	const q = (s, r=document) => r.querySelector(s);
	const qa = (s, r=document) => Array.from(r.querySelectorAll(s));
	let auth = null;
	qa('.toggle').forEach(t=>t.addEventListener('click', ()=>t.classList.toggle('on')));

	q('#fill').addEventListener('click', ()=>{ const u=new URL(location.href); ['chatId','userId','timestamp','hash'].forEach(id=>{ const k=id==='chatId'?'chat_id':(id==='userId'?'user_id':id); const v=u.searchParams.get(k); if(v) q('#'+id).value=v; }); });

	q('#auth').addEventListener('click', async ()=>{
		auth = { chat_id:q('#chatId').value?Number(q('#chatId').value):0, user_id:Number(q('#userId').value), timestamp:Number(q('#timestamp').value), hash:q('#hash').value };
		if(!auth.user_id||!auth.timestamp||!auth.hash) return alert('ورودی نامعتبر');
		const r = await fetch('/api/auth',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(auth)});
		const j = await r.json(); if(!j.ok) return alert('احراز هویت ناموفق');
		if(auth.chat_id){ await loadSettings(); await loadAdmins(); await loadSanctions(); await loadOwner(); q('#settings').style.display='block'; q('#admins').style.display='block'; q('#sanctions').style.display='block'; }
		else { await loadMyChats(); q('#myChats').style.display='block'; }
	});

	function renderSettings(s){ qa('.toggle').forEach(t=>{ const k=t.dataset.key; s[k]?t.classList.add('on'):t.classList.remove('on'); }); q('#max_warns').value=s.max_warns; q('#welcome_banner_url').value=s.welcome_banner_url||''; q('#welcome_text').value=s.welcome_text||''; }
	function collectSettings(){ const r={ chat_id:auth.chat_id, max_warns:Number(q('#max_warns').value), welcome_banner_url:q('#welcome_banner_url').value, welcome_text:q('#welcome_text').value };
		qa('.toggle').forEach(t=>{ const key=t.dataset.key; r[key]=t.classList.contains('on')?1:0; });
		return r; }

	async function loadSettings(){ const url = `/api/settings?chat_id=${auth.chat_id}&user_id=${auth.user_id}&timestamp=${auth.timestamp}&hash=${encodeURIComponent(auth.hash)}`; const j=await (await fetch(url)).json(); if(j.ok) renderSettings(j.settings); }
	q('#save').addEventListener('click', async ()=>{ const url = `/api/settings?chat_id=${auth.chat_id}&user_id=${auth.user_id}&timestamp=${auth.timestamp}&hash=${encodeURIComponent(auth.hash)}`; const j=await (await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(collectSettings())})).json(); if(j.ok) alert('ذخیره شد'); });

	async function loadAdmins(){ const url=`/api/admins?chat_id=${auth.chat_id}&user_id=${auth.user_id}&timestamp=${auth.timestamp}&hash=${encodeURIComponent(auth.hash)}`; const j=await (await fetch(url)).json(); const tb=q('#admins tbody'); tb.innerHTML=''; (j.admins||[]).forEach(a=>{ const u=a.user; const tr=document.createElement('tr'); tr.innerHTML=`<td>${u.first_name||''} ${u.last_name||''} (@${u.username||''})</td>
		<td><input type="checkbox" data-flag="can_delete_messages" ${a.can_delete_messages?'checked':''}></td>
		<td><input type="checkbox" data-flag="can_restrict_members" ${a.can_restrict_members?'checked':''}></td>
		<td><input type="checkbox" data-flag="can_pin_messages" ${a.can_pin_messages?'checked':''}></td>
		<td><input type="checkbox" data-flag="can_manage_chat" ${a.can_manage_chat?'checked':''}></td>
		<td><button data-action="save">اعمال</button></td>`; tb.appendChild(tr);
		tr.querySelector('button[data-action="save"]').addEventListener('click', async ()=>{
			const rights={}; tr.querySelectorAll('input[type="checkbox"]').forEach(ch=>rights[ch.dataset.flag]=ch.checked);
			const url='/api/admins/set?chat_id='+auth.chat_id+'&user_id='+auth.user_id+'&timestamp='+auth.timestamp+'&hash='+encodeURIComponent(auth.hash);
			await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:u.id, rights})}); alert('ثبت شد');
		});
		}); }

	async function loadOwner(){ const url=`/api/owner/state?chat_id=${auth.chat_id}&user_id=${auth.user_id}&timestamp=${auth.timestamp}&hash=${encodeURIComponent(auth.hash)}`; const r=await fetch(url); if(r.status===200){ const j=await r.json(); q('#owner').style.display='block'; q('#botDisabled').value = String(j.state.disabled||0); q('#forceChannelId').value = String(j.state.force_channel_id||''); } }
	q('#saveOwner').addEventListener('click', async ()=>{ const url=`/api/owner/state?chat_id=${auth.chat_id}&user_id=${auth.user_id}&timestamp=${auth.timestamp}&hash=${encodeURIComponent(auth.hash)}`; const body={ disabled:Number(q('#botDisabled').value), force_channel_id:q('#forceChannelId').value }; const j=await (await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})).json(); if(j.ok) alert('ذخیره شد'); });

	async function loadSanctions(){ const url=`/api/sanctions?chat_id=${auth.chat_id}&user_id=${auth.user_id}&timestamp=${auth.timestamp}&hash=${encodeURIComponent(auth.hash)}`; const j=await (await fetch(url)).json(); const tb=q('#sanctions tbody'); tb.innerHTML=''; (j.sanctions||[]).forEach(s=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${s.user_id}</td><td>${s.action}</td><td>${s.reason||''}</td><td>${new Date(s.created_at).toLocaleString()}</td>`; tb.appendChild(tr); }); }

	async function loadMyChats(){
		const params = new URLSearchParams({ user_id:String(auth.user_id), timestamp:String(auth.timestamp), hash:auth.hash });
		const j = await (await fetch('/api/my_chats?'+params.toString())).json();
		const tb = q('#myChats tbody'); tb.innerHTML='';
		(j.chats||[]).forEach(c=>{
			const tr=document.createElement('tr');
			tr.innerHTML=`<td>${c.title||c.chat_id}</td><td>${c.chat_id}</td><td>${c.type}</td><td><button data-id="${c.chat_id}">مدیریت</button></td>`;
			tr.querySelector('button').addEventListener('click', async ()=>{
				auth.chat_id = c.chat_id;
				await loadSettings(); await loadAdmins(); await loadSanctions(); await loadOwner();
				q('#settings').style.display='block'; q('#admins').style.display='block'; q('#sanctions').style.display='block';
				window.scrollTo({top:0,behavior:'smooth'});
			});
			tb.appendChild(tr);
		});
	}
	</script>
</body>
</html>